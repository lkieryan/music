
# 音乐插件系统架构图

## 当前系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (Frontend)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Music UI      │  │   Settings UI   │  │   Player UI     │ │
│  │   Component     │  │   Component     │  │   Component     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Tauri Commands
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Tauri Backend (src-tauri)                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   Music Router                              │ │
│  │  ┌─────────────────┐                                        │ │
│  │  │   search()      │  ←───── 调用 get_audio_providers_by_selection() │
│  │  │   function      │        (但此方法未实现)                   │ │
│  │  └─────────────────┘                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 Music Resolver                              │ │
│  │  ┌─────────────────┐                                        │ │
│  │  │ resolve_playback│  ←───── 调用 get_audio_providers_by_selection() │
│  │  │   _url()        │        (但此方法未实现)                   │ │
│  │  └─────────────────┘                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 期望直接调用插件方法
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Plugin Manager                               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │  get_plugin()         ← 已实现                               │ │
│  │  get_all_plugins()    ← 已实现                               │ │
│  │                                                         │ │
│  │  get_audio_providers_by_selection() ← 未实现 ❌             │ │
│  │  get_plugins_by_selection()          ← 未实现 ❌             │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 返回 Arc<Mutex<dyn Plugin>>
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Plugin Registry                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │BilibiliPlugin│  │YouTubePlugin│  │SpotifyPlugin│             │
│  │             │  │             │  │             │             │
│  │  - Plugin   │  │  - Plugin   │  │  - Plugin   │             │
│  │    trait    │  │    trait    │  │    trait    │             │
│  │             │  │             │  │             │             │
│  │  - as_any() │  │  - as_any() │  │  - as_any() │             │
│  │  - as_any_  │  │  - as_any_  │  │  - as_any_  │             │
│  │    mut()    │  │    mut()    │  │    mut()    │             │
│  │             │  │             │  │             │             │
│  │  - Audio-   │  │  - Audio-   │  │  - Audio-   │             │
│  │    Provider │  │    Provider │  │    Provider │             │
│  │    trait    │  │    trait    │  │    trait    │             │
│  │    (部分)   │  │    (部分)   │  │    (部分)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 目标系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (Frontend)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Music UI      │  │   Settings UI   │  │   Player UI     │ │
│  │   Component     │  │   Component     │  │   Component     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Tauri Commands (不变)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Tauri Backend (src-tauri)                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   Music Router                              │ │
│  │  ┌─────────────────┐                                        │ │
│  │  │   search()      │  ←───── 调用 get_plugins_by_selection()   │
│  │  │   function      │        ↓                              │ │
│  │  │                 │     获取完整插件实例                      │ │
│  │  │                 │     ↓                              │ │
│  │  │                 │     使用 as_any_mut() 向下转换            │ │
│  │  │                 │     ↓                              │ │
│  │  │                 │     直接调用插件的 search() 方法         │ │
│  │  └─────────────────┘                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 Music Resolver                              │ │
│  │  ┌─────────────────┐                                        │ │
│  │  │ resolve_playback│  ←───── 调用 get_plugins_by_selection()   │
│  │  │   _url()        │        ↓                              │ │
│  │  │                 │     获取完整插件实例                      │ │
│  │  │                 │     ↓                              │ │
│  │  │                 │     使用 as_any_mut() 向下转换            │ │
│  │  │                 │     ↓                              │ │
│  │  │                 │     直接调用插件的 get_stream_url() 方法  │ │
│  │  └─────────────────┘                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 直接调用插件方法
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Plugin Manager                               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │  get_plugin()         ← 已实现                               │ │
│  │  get_all_plugins()    ← 已实现                               │ │
│  │                                                         │ │
│  │  get_plugins_by_selection()          ← 新实现 ✅           │ │
│  │  get_all_enabled_plugins()           ← 新实现 ✅           │ │
│  │  get_plugin_instance_safe()          ← 新实现 ✅           │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 返回 Arc<Mutex<dyn Plugin>>
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Plugin Registry                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │BilibiliPlugin│  │YouTubePlugin│  │SpotifyPlugin│             │
│  │             │  │             │  │             │             │
│  │  - Plugin   │  │  - Plugin   │  │  - Plugin   │             │
│  │    trait    │  │    trait    │  │    trait    │             │
│  │             │  │             │  │             │             │
│  │  - as_any() │  │  - as_any() │  │  - as_any() │             │
│  │  - as_any_  │  │  - as_any_  │  │  - as_any_  │             │
│  │    mut()    │  │    mut()    │  │    mut()    │             │
│  │             │  │             │  │             │             │
│  │  - Audio-   │  │  - Audio-   │  │  - Audio-   │             │
│  │    Provider │  │    Provider │  │    Provider │             │
│  │    trait    │  │    trait    │  │    trait    │             │
│  │    (完整)   │  │    (完整)   │  │    (完整)   │             │
│  │             │  │             │  │             │             │
│  │  - Auth-    │  │  - Auth-    │  │  - Auth-    │             │
│  │    Provider │  │    Provider │  │    Provider │             │
│  │    trait    │  │    trait    │  │    trait    │             │
│  │    (完整)   │  │    (完整)   │  │    (完整)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 架构关键点说明

### 1. 当前系统问题

**问题点1：缺少通用插件获取机制**
- `PluginManager` 中缺少 `get_plugins_by_selection()` 方法
- `router.rs` 和 `resolve.rs` 中调用的 `get_audio_providers_by_selection()` 方法未实现

**问题点2：无法获取完整插件实例**
- 当前系统只能获取 `Arc<Mutex<dyn Plugin>>`，无法直接访问特定插件的所有功能
- 缺少类型安全的向下转换机制来获取完整的插件实例（如 BilibiliPlugin）

**问题点3：无法直接调用插件方法**
- 当前系统设计为通过事件系统调用插件方法，而不是直接调用
- 无法直接访问插件的特定功能（如登录、获取音频等）

### 2. 目标系统改进

**改进点1：实现通用插件获取机制**
- 在 `PluginManager` 中实现 `get_plugins_by_selection()` 方法
- 根据前端选择（All/Single/Many）返回对应的插件实例列表

**改进点2：类型安全的插件转换**
- 使用 `as_any()` 和 `as_any_mut()` 方法进行向下转换
- 将 `dyn Plugin` 转换为具体的插件类型（如 BilibiliPlugin）

**改进点3：直接方法调用**
- 直接调用插件实例的方法，而不是通过事件系统
- 可以访问插件的所有功能（搜索、获取音频、登录等）

### 3. 数据流向

**当前系统数据流向**：
```
前端 → Tauri Commands → router/resolve → (期望调用) get_audio_providers_by